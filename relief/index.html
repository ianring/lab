<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bas-Relief from PNG (Three.js with Modules)</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script type="module">
    // import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    // import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';


    // import * as THREE from 'https://cdn.skypack.dev/three@0.160.0';
    // import { OrbitControls } from 'https://cdn.skypack.dev/three@0.160.0/examples/jsm/controls/OrbitControls.js';

    // import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    // import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

import * as THREE from 'https://esm.sh/three@0.160.0';
import { OrbitControls } from 'https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js';


    let scene, camera, renderer, controls;

    init();
    loadHeightmap('./greenman6.png'); // Replace with your own PNG

    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 10, 20);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Lighting
      const ambient = new THREE.AmbientLight(0xffffff, 0.4);
      scene.add(ambient);
      const directional = new THREE.DirectionalLight(0xffffff, 0.8);
      directional.position.set(10, 10, 10);
      scene.add(directional);

      animate();
    }

    function loadHeightmap(src) {
      const image = new Image();
      image.src = src;
      image.crossOrigin = ""; // Allow CORS if needed

      image.onload = () => {
        const imgWidth = image.width;
        const imgHeight = image.height;

        const canvas = document.createElement('canvas');
        canvas.width = imgWidth;
        canvas.height = imgHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(image, 0, 0, imgWidth, imgHeight);
        const imageData = ctx.getImageData(0, 0, imgWidth, imgHeight).data;

        // Plane geometry with subdivisions matching image resolution
        const geometry = new THREE.PlaneGeometry(10, 10, imgWidth - 1, imgHeight - 1);
        const vertices = geometry.attributes.position;

        const heightScale = 0.5;

        for (let i = 0; i < vertices.count; i++) {
          const x = i % imgWidth;
          const y = Math.floor(i / imgWidth);
          const pixelIndex = (y * imgWidth + x) * 4;
          const r = imageData[pixelIndex];
          const g = imageData[pixelIndex + 1];
          const b = imageData[pixelIndex + 2];
          const brightness = (r + g + b) / 3;
          const height = brightness / 255;
          vertices.setZ(i, height * heightScale); // scale Z
        }

        vertices.needsUpdate = true;
        geometry.computeVertexNormals();

        const material = new THREE.MeshStandardMaterial({
          color: 0xdddddd,
          side: THREE.DoubleSide,
          flatShading: false
        });

        const mesh = new THREE.Mesh(geometry, material);
        mesh.rotation.x = -Math.PI / 2;
        scene.add(mesh);
      };
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
